---
title: "Analysis"
author: "Alex Jenke"
date: "2024-11-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(visdat)
library(dplyr)
```

### Our Idea
was to investigate the effects and interactions between different diseases, especially between those affecting the physical and those affecting the cognitive wellbeing of an individual.
In order to do this we use a tidy-tuesday dataset (patient risk profiles) that "contains 100 simulated patient's medical history features and the predicted 1-year risk of 14 outcomes based on each patient's medical history features. The predictions used real logistic regression models developed on a large real world healthcare dataset."

### Limitations:
While this dataset brings the advantage of indirectly containing a lot of data, it only simulated 100 people. This means we are forced to rely, to some extent, on the previously done statistics, as the statistical power of 100 datapoints is limited. Another limitation, related to the first is that the values provided in the dataset are the results of the regression model the authors developed. Thus, we are bounded by their statistical regression model. Despite this, we believe these factors to be negligible; The dataset was published as a tidy-tuesday dataset, which indicates a reliability and quality sufficient for the scope of this project.

### Hypothesis:
Patients aged 65-69 with prior occurrences of cardiovascular-related conditions (e.g., angina, atrial fibrillation, coronary artery disease) are at higher predicted risk of dementia compared to other age groups with similar conditions.

We believe this for the following reasons:

1. **Aging and Cognitive Decline**
   + Aging is the primary risk factor for cognitive decline and dementia. The age group 65-69 falls into a critical period when many individuals begin to show early signs of cognitive impairment, which may develop into dementia. For example, the risk of Alzheimer's disease growths exponentially with age from less than 5% at 65 to 40% beyond the age of 85 [See The Impact of Age on Cognition]
   + Neurological  resilience diminishes with age, making the brain more vulnerable to damage from systemic conditions like cardiovascular diseases [See Aging leads to altered microglial function that reduces brain resiliency increasing vulnerability to neurodegenerative diseases].
   + Sleep quality decreases with growing age, which affects the glymphatic system. Lower glymphatic clearance may lead to proteine accumulation in the brain, which is associated with neurodegenerative diseases like Alzheimer's. [See Glymphatic failure as a final common pathway to dementia]
2. **Cardiovascular Conditions and Cerebral Health**
   + Cardiovascular conditions such as angina, atrial fibrillation, and coronary artery disease can impair blood flow to the brain, leading to vascular contributions to cognitive impairment and dementia. Reduced blood flow and microvascular damage to the brain could accelerate neurodegeneration.[See Neurovascular dysfunction and neurodegeneration in dementia and Alzheimer's disease]
   + Atrial fibrillation, in particular, increases the risk of stroke and microinfarcts in the brain, both of which are linked to an increased likelihood of developing dementia. [See Atrial Fibrillation, Cognitive Decline and Dementia]
3. **Heightened Risk in the 65-69 Age Group**
   + At ages 65-69, patients are more likely to experience the combined effects of aging and systemic diseases compared to younger groups, but they may not yet have the compensatory mechanisms seen in older populations who have "adapted" to chronic health changes. Furthermore, the unwillingness to acknowledge one-self aging might adversely affect the willingness to seek these adaptions.
   + This age group is often where early signs of dementia begin to appear. Cardiovascular conditions can act as triggers to or exacerbate the progression of this process.

#### Presumed Causal Relationships:
![Causal Relationships](data/causality_graph.svg)

## Get the dataset and check the na values
```{r}
#tuesdata <- read.csv("./data/patient_risk_profiles.csv")
tuesdata <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2023/2023-10-24/patient_risk_profiles.csv')
```



#### Rename all the columns to increasing numbers to make it easier to visualize how much of the data is missing as opposed to what data is missing. That is, so the column names do not distract from the visualization.

```{r}
columns <- colnames(tuesdata) %>%
    set_names() %>%
    as_tibble() %>%
    mutate(column_number = row_number()) %>%
    pull(column_number)
visualization_df <- tuesdata %>%
    set_names(columns)
vis_miss(visualization_df, show_perc_col = FALSE)

present_percent <- visualization_df %>%
    summarise_all(~sum(!is.na(.))/n()) %>%
    gather() %>%
    pull(value) %>%
    first()
```
#### As can be seen also in the visualization above, `r present_percent*100`% of the data is present.

### Data Cleaning
Now select
```{r}
data <- tuesdata %>%
  select(personId,
         starts_with("age group:"),
         Angina = `Angina events in prior year`,
         AF = `Atrial Fibrillation, incident in prior year`,
         CAD = `Coronary artery disease (CAD) in prior year`,
         HF = `Heart failure in prior year`,
         HVD = `Heart valve disorder in prior year`,
         Dementia_risk = `predicted risk of Dementia`,
  )
colnames(data) <- gsub(pattern = "age group:  ", replacement ="ag", colnames(data)) %>%
    gsub(pattern = " -  ", replacement ="_", colnames(data)) %>%
    gsub(pattern = " ", replacement ="", colnames(data)) %>%
    gsub(pattern = "ag5_9", replacement = "ag05_9", colnames(data))

data %>%
  select(ag0_4, Angina, AF, CAD, Dementia_risk) %>%
    head()


```

## Feature Engineering:
To improve the usability of the dataset and enable meaningful analysis,  a new variable, Cardio_Condition, was created, which indicates the presence of cardiovascular disease. This binary feature was derived from existing variables indicating certain conditions such as angina pectoris, atrial fibrillation, coronary artery disease, heart failure and valve heart disorder. In addition, the dataset was transformed so that each person could be assigned to a single corresponding age group, allowing for a more streamlined analysis. These transformations should facilitate the examination of age-specific trends in dementia risk and their potential association with cardiovascular health.

```{r}
cleaned_data <- data %>%
        mutate(Cardio_Condition = ifelse(
                Angina == 1 | AF == 1 | CAD == 1 | HF == 1 | HVD == 1, 1, 0)
        ) %>%
        pivot_longer(cols = starts_with("ag"), # make it appear longer
                     names_to = "Age_Group",
                     values_to = "Age_Group_Value") %>%
        filter(Age_Group_Value == 1) %>%
        select(-Age_Group_Value) %>%
        mutate(Age_Group = as.factor(Age_Group))
head(cleaned_data)
```
The data now contains the columns `r colnames(cleaned_data)` and `r nrow(cleaned_data)` rows from the initial `r ncol(tuesdata)` columns and `r nrow(tuesdata)` rows.

## Exploratory Data Analysis
The exploratory data analysis focuses on understanding the relationship between cardiovascular conditions and dementia risk across different age groups. The data is grouped by age and the presence or absence of cardiovascular conditions. For each group, the average predicted dementia risk is calculated, enabling comparisons between individuals with and without cardiovascular conditions, as well as among different age categories.

Bar plots visualize the average dementia risks for both groups, showing that individuals with cardiovascular conditions generally have higher predicted risks of dementia across most age groups. The relative difference in dementia risk between these groups is also calculated and visualized, highlighting age groups where cardiovascular conditions are associated with greater disparities in risk.

Density plots explore the distribution of predicted dementia risks within selected age groups, providing insights into how risk is distributed across individuals. Additionally, the average predicted dementia risk for each age group is summarized and visualized, offering a good view of how dementia risk varies with age. These analyses lay the groundwork for hypothesis testing and deeper investigation into the interactions between age, cardiovascular health, and dementia risk.
```{r}
heart_people <- cleaned_data %>%
        filter(Cardio_Condition == 1) %>% # only the people with heart
        group_by(Age_Group) %>%
        summarise(with_heart = n(), Dementia_risk_heart = mean(Dementia_risk, na.rm = TRUE))

no_heart_people <- cleaned_data %>%
        filter(Cardio_Condition == 0) %>% # only the people without heart
        group_by(Age_Group) %>%
        summarise(without_heart = n(), Dementia_risk_no_heart = mean(Dementia_risk, na.rm = TRUE))

all_people <- no_heart_people %>%
        left_join(heart_people, by = "Age_Group") %>%
        mutate(Dementia_risk_diff = Dementia_risk_heart - Dementia_risk_no_heart) %>%
        mutate(amount = without_heart + with_heart) %>%
        select(Age_Group, Dementia_risk_diff, Dementia_risk_heart, Dementia_risk_no_heart, amount, with_heart) %>%
        arrange(desc(Dementia_risk_diff))

all_people

# plot both the avg dementia risk for people with and without heart conditions
ggplot(all_people, aes(x = Age_Group)) +
        geom_bar(aes(y = Dementia_risk_heart, fill = "With Heart"), stat = "identity") +
        geom_bar(aes(y = Dementia_risk_no_heart, fill = "Without Heart"), stat = "identity", width = 0.5) +
        labs(title = "Average Predicted Risk of Dementia by Age Group",
                x = "Age Group",
                y = "Average Predicted Risk of Dementia",
                fill = "Heart Condition")

relative_difference <- all_people %>%
        mutate(relative_diff = Dementia_risk_heart / Dementia_risk_no_heart) %>%
        arrange(desc(relative_diff))

ggplot(relative_difference, aes(x = Age_Group, y = relative_diff, fill = Age_Group)) +
        geom_bar(stat = "identity") +
        labs(title = "Relative Difference in Predicted Risk of Dementia by Age Group",
                x = "Age Group",
                y = "Relative Difference in Predicted Risk of Dementia",
                fill = "Age Group")

relavant_data <- cleaned_data

truncated_data <- relavant_data %>% filter(Age_Group %in% c("ag60_64", "ag65_69", "ag70_74"))#, "ag75_79", "ag80_84", "ag85_89", "ag90_94", "ag95_99"))

ggplot(truncated_data, aes(x = Dementia_risk, fill = Age_Group)) +
        geom_density(alpha = 0.5) +
        labs(title = "Predicted Risk of Dementia by Age Group",
                x = "Predicted Risk of Dementia",
                y = "Density",
                fill = "Age Group")

ggplot(relavant_data, aes(x = Dementia_risk, y = 1, color = Age_Group, fill = Age_Group)) +
        #geom_jitter(width = 0.01, height = 0.0) +
        geom_bar(stat = "identity")
        labs(title = "Predicted Risk of Dementia by Age Group",
                x = "Predicted Risk of Dementia",
                y = "1",
                color = "Age Group")
avg_risk <- relavant_data %>%
        group_by(Age_Group) %>%
        summarise(avg_risk = mean(Dementia_risk, na.rm = TRUE))
ggplot(avg_risk, aes(x = Age_Group, y = avg_risk, fill = Age_Group)) +
        geom_bar(stat = "identity") +
        labs(title = "Average Predicted Risk of Dementia by Age Group",
                x = "Age Group",
                y = "Average Predicted Risk of Dementia",
                fill = "Age Group")
```
```{r}
model_exp <- lm(log(Dementia_risk) ~ as.numeric(Age_Group), data = cleaned_data)
model_lin <- lm(Dementia_risk ~ as.numeric(Age_Group), data = cleaned_data)
model_quad <- lm(sqrt(Dementia_risk) ~ as.numeric(Age_Group), data = cleaned_data)
r_squared_exp <- summary(model_exp)$r.squared
r_squared_lin <- summary(model_lin)$r.squared
r_squared_quad <- summary(model_quad)$r.squared
cleaned_data$predicted_y_log <- exp(predict(model_exp, newdata = cleaned_data))
cleaned_data$predicted_y_lin <- predict(model_lin, newdata = cleaned_data)
cleaned_data$predicted_y_quad <- predict(model_quad, newdata = cleaned_data)^2

ggplot(cleaned_data, aes(x = as.numeric(Age_Group), y = Dementia_risk)) +
        geom_point() +
        geom_line(aes(y = predicted_y_log), color = "blue")  +
        geom_line(aes(y = predicted_y_lin), color = "red") +
        geom_line(aes(y = predicted_y_quad), color = "green") +
        labs(title = "Predicted Risk of Dementia by Age Group",
                x = "Age Group",
                y = "Predicted Risk of Dementia",
                color = "Model Type")

```
## Hypothesis Testing
To test the hypothesis that patients aged 65-69 with prior cardiovascular conditions have a higher predicted risk of dementia compared to other age groups with similar conditions, we perform the following statistical analysis:

1. Subset the Data

Filter the data to include only rows where cardiovascular conditions are present and separate it into two groups:
+ Patients aged 65-69.
+ Patients in other age groups.
```{r}
subset_65_69 <- cleaned_data %>%
  filter(Age_Group == "ag65_69", Cardio_Condition == 1)

subset_others <- cleaned_data %>%
  filter(Age_Group != "ag65_69", Cardio_Condition == 1)
```

2. Perform a Two-Sample t-Test
We compare the mean predicted dementia risk between the two groups using a two-sample t-test. The null hypothesis (H₀) is that the means are equal, and the alternative hypothesis (H₁) is that the mean for the 65-69 age group is higher.

```{r}
dementiarisk_65_69 <- data.frame(
  Dementia_risk = c(subset_65_69$Dementia_risk, subset_65_69$Dementia_risk)) # as the data is too small
dementiarisk_others <- subset_others$Dementia_risk
t_test_result <- t.test(
  dementiarisk_65_69,
  dementiarisk_others,
  alternative = "greater",
  var.equal = FALSE
)
t_test_result
p_value <- t_test_result$p.value
```
If the p-value is less than 0.05, we reject the null hypothesis and conclude that patients aged 65-69 with prior cardiovascular conditions have a higher predicted risk of dementia compared to other age groups with similar conditions. Otherwise, we fail to reject the null hypothesis.
Our p-value is `r p_value`. Therefore, we fail to reject the null hypothesis. This suggests that there is no statistically significant difference in the predicted risk of dementia between patients aged 65-69 with prior cardiovascular conditions and patients in other age groups with similar conditions, given the data we have.

## Results
The analysis aimed to examine the relationship between cardiovascular conditions and dementia risk across age groups. However, it is crucial to note that the hypothesis test relied on a very limited dataset with only one data point (which was duplicated), severely limiting the statistical power and reliability of the results. Key findings include:
1.	Average Predicted Risk:
   + Patients with cardiovascular conditions generally exhibited a higher predicted risk of dementia than those without such conditions across all age groups.
   + The age group 65-69 showed no statistically significant difference in dementia risk compared to other age groups with similar cardiovascular conditions, as indicated by a p-value of `r p_value` (greater than 0.05).
2. Relative Risk Differences:
   + While the age group 65-69 had a marginally higher average dementia risk, than its neighboring age groups, the differences were not significant enough to confirm a unique vulnerability compared to other groups.
3.	Visualization Insights:
   + The bar plots and density distributions highlighted variations in predicted dementia risks across age groups, with a trend of increased risk in older age groups.
   + The increase in dementia risk when cardiovascular conditions were present seems to be more pronounced in younger age groups. This could be due to the fact that without any cardiovascular conditions, the risk of dementia is generally lower in younger age groups, making the relative increase more noticeable.
   +
## Conclusion
The hypothesis that patients aged 65-69 with prior cardiovascular conditions are at a higher predicted risk of dementia compared to other age groups was inconclusive due to the dataset’s severe limitations. The reliance on only two data points for the hypothesis test undermines the ability to draw meaningful conclusions.

The observed trends suggest potential relationships worth exploring, but the results cannot confirm or refute the hypothesis in its current form.

## Next Steps
1. Increase Sample Size: Obtain a larger dataset with more diverse and real-world patient records to perform a statistically valid analysis.
2. Refine Data: Ensure age groups and conditions are sufficiently represented to support meaningful subgroup comparisons.

## Sources:
1. Alonso A, Arenas de Larriva AP. Atrial Fibrillation, Cognitive Decline And Dementia. Eur Cardiol. 2016 Summer;11(1):49-53. doi: 10.15420/ecr.2016:13:2. PMID: 27547248; PMCID: PMC4988519.
2. Bickford PC, Flowers A, Grimmig B. Aging leads to altered microglial function that reduces brain resiliency increasing vulnerability to neurodegenerative diseases. Exp Gerontol. 2017 Aug;94:4-8. doi: 10.1016/j.exger.2017.01.027. Epub 2017 Feb 2. PMID: 28163132; PMCID: PMC5469713.
3. Murman DL. The Impact of Age on Cognition. Semin Hear. 2015 Aug;36(3):111-21. doi: 10.1055/s-0035-1555115. PMID: 27516712; PMCID: PMC4906299.
4. Nelson AR, Sweeney MD, Sagare AP, Zlokovic BV. Neurovascular dysfunction and neurodegeneration in dementia and Alzheimer's disease. Biochim Biophys Acta. 2016 May;1862(5):887-900. doi: 10.1016/j.bbadis.2015.12.016. Epub 2015 Dec 17. PMID: 26705676; PMCID: PMC4821735.
